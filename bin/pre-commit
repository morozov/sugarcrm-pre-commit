#!/bin/bash

STANDARD=SugarCRM

SRC_DIR=$(git rev-parse --show-toplevel)
[ $? -eq 0 ] || exit $?;

TMP_DIR=$(mktemp -d /tmp/tmp.XXXXXXXXXX)
[ $? -eq 0 ] || exit $?;

FILES=$(git diff --staged --diff-filter=ACM --name-only)
[ -n "$FILES" ] || exit 0;

echo "$FILES" | xargs -I% git checkout-index --prefix="$TMP_DIR/" -- %

export PHPCS_SRC_DIR=$SRC_DIR
export PHPCS_TMP_DIR=$TMP_DIR

__FILE__=$(readlink $0)
__DIR__=$(dirname "$__FILE__/")

cd "$__DIR__/.."
php -d auto_prepend_file=src/PHP/CodeSniffer/Reports/Xml.php vendor/bin/phpcs --standard=$STANDARD --report=xml $TMP_DIR
RESULT=$?

# cleaning temporary directory
rm -rf $TMP_DIR

exit $RESULT;
